<?xml version="1.0"?>
<tool id="Compare_BLAST" name="Compare BLAST" version="1.0">
	<description>Compare muliple BLAST results</description>

	<!-- collect the parameters and provide these to the wrapper script -->
	<command interpreter="bash">

		Compare_BLAST.sh
		$input_type.input_format
		#if $abundance.value == True
			"-A"
			#if $input_type.input_format == "hist"
				$output_blast_png
			#else
				$output_zip_png
			#end if
		#else
			" "
			" "
		#end if
		$taxon_level
		#if $order.value == True
			"order"
		#else
			" "
		#end if
		#if $input_type.input_format == "hist"
			$output_tsv
			$output_blast_html
			#for $blast in $input_type.add_blast
				${blast.input_blast},"${blast.input_blast.display_name}"
			#end for
		#else
			$output_zip
			$output_zip_html
			$input_type.input_zip
		#end if

	</command>

	<inputs>
		<!-- get the input files and input filetypes -->
		<conditional name="input_type">
			<param name="input_format" type="select" label="Single file or ZIP archive?">
				<option value="hist">Single file</option>
				<option value="zip">ZIP archive</option>
			</param>
			<when value="hist">
				<repeat name="add_blast" title="BLAST results">
					<param name="input_blast" type="data" format="tabular" label="BLAST file" help="BLAST results file." />
				</repeat>
			</when>
			<when value="zip">
				<param name="input_zip" type="data" format="zip" label="ZIP file containing the BLAST results" help="ZIP file." />
			</when>
		</conditional>
		<param name="abundance" type="boolean" checked="true" label="BLAST contains cluster size" help="Check if the BLAST output contains the cluster size, generated by the Expand_BLAST option in Galaxy." />
		<param name="taxon_level" type="select" label="Lowest taxonomic level to use for the heatmap." help="Taxonomic ranks lower than the selected rank will be summarized to the selected rank. This setting does not influence the comparison table or the Krona piechart.">
			<option value="kingdom-1">Kingdom</option>
			<option value="Phylum-2">Phylum</option>
			<option value="Class-3">Class</option>
			<option value="Order-4">Order</option>
			<option value="Family-5" selected="true">Family</option>
			<option value="Genus-6">Genus</option>
			<option value="Species-7">Species</option>
		</param>
		<param name="order" type="boolean" checked="true" label="Group the heatmap output based on taxonomy" help="If checked the heatmap output is grouped based on taxonomy, if uncheck the output is clustered based on similarity." />
	</inputs>

	<outputs>
		<!-- set the output name based on the input file type and name -->
		<data format="tabular" name="output_zip" label="$input_type.input_zip.display_name Comparison">
			<filter>input_type['input_format'] == "zip"</filter>
		</data>
		<data format="tabular" name="output_tsv" label="Comparison" >
			<filter>input_type['input_format'] != "zip"</filter>
		</data>
		<data format="html" name="output_zip_html" label="$input_type.input_zip.display_name Chart">
			<filter>input_type['input_format'] == "zip"</filter>
		</data>
		<data format="html" name="output_blast_html" label="Chart" > 
			<filter>input_type['input_format'] != "zip"</filter>
		</data>
		<data format="png" name="output_zip_png" label="$input_type.input_zip.display_name Heatmap">
			<filter>input_type['input_format'] == "zip"</filter>
		</data>
		<data format="png" name="output_blast_png" label="Heatmap">
			<filter>input_type['input_format'] != "zip"</filter>
		</data>
	</outputs>

	<tests>
	</tests>

	<help>
		Compare the output from multiple BLAST files. The output is a new BLAST file that compares the number of hits / reads (if abundance info is present in the BLAST files) between the different samples. A Krona piechart to vizualize the distribution of the different BLAST results between the samples. And finally, if abundance data is present, a heat map that clusters the BLAST hits and samples. For the input file, only the first BLAST hit for each cluster is used, using multiple hits per cluster would skew the abundance output.

		Krona (tool that created the piechart) reference: Ondov BD, Bergman NH, Phillippy AM. Interactive metagenomic visualization in a Web browser. *BMC Bioinformatics* 2011, **12**:385.
		Phyloseq (R package used for creating the heatmap) reference: McMurdie PJ and Holmes S. phyloseq: An R Package for Reproducible Interactive Analysis and Graphics of Microbiome Census Data. *PLoS ONE* 2013, **8(4)**:e61217.
	</help>
</tool>
